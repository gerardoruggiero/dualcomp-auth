# PLAN TÉCNICO - Feature 0006: Flujo de Validación y Gestión de Usuarios

## Descripción
Implementación del flujo completo de validación de usuarios por email, cambio obligatorio de contraseña en primer login, envío de emails de notificación, configuración de servidor de correo por empresa y gestión de usuarios desde el dashboard.

## Requerimientos Específicos
- Validación de cuenta por email con enlace de activación
- Cambio obligatorio de contraseña en primer login con clave temporal
- Envío de emails en registro de empresa, edición de empresa y creación de usuarios
- Cuenta inactiva hasta validación por email
- Reinicio de clave por administradores (IsCompanyAdmin = true)
- Configuración de servidor SMTP por empresa (multitenant)
- Accesos en dashboard para gestión de usuarios y configuración de empresa
- Reinicio de clave por medio del link "Olvidé mi clave" del formulario de login. Pedirá un mail y se reutilizará el flujo de "Reinicio de clave por administradores (IsCompanyAdmin = true)": envio de mail y redirección a la pantalla de cambio de clave (como no recuerda la actual, no debe pedirla).

## Análisis del Modelo Actual
- Tabla `Users` ya tiene campo `IsActive` para control de estado
- Tabla `Users` ya tiene campo `IsCompanyAdmin` para permisos
- Flujo de registro de empresas crea usuarios automáticamente
- Existe validación de contraseñas con parámetros configurables
- Sistema de autenticación JWT ya implementado

## Archivos y Funciones a Modificar/Crear

### 1. BASE DE DATOS (Dualcomp.Auth.Database)

#### Nuevos Scripts SQL:
- `004_EmailValidationAndSettings.sql`
  - Tabla `EmailValidations`: almacenar tokens de validación
  - Tabla `CompanySettings`: configuración SMTP por empresa
  - Campos adicionales en `Users`: `IsEmailValidated`, `MustChangePassword`, `TemporaryPassword`

### 2. BACKEND - DOMAIN (Dualcomp.Auth.Domain)

#### Nuevas Entidades:
- `EmailValidation.cs`: entidad para tokens de validación
- `CompanySettings.cs`: configuración SMTP por empresa

#### Modificaciones:
- `User.cs`: agregar métodos para validación de email y cambio obligatorio de contraseña
- `Company.cs`: agregar relación con configuración de email

#### Nuevos Value Objects:
- `EmailValidationToken.cs`: token único para validación
- `SmtpSettings.cs`: configuración SMTP

### 3. BACKEND - APPLICATION (Dualcomp.Auth.Application)

#### Nuevos Commands/Queries:
- `ValidateEmail/`: validar cuenta por token
- `ForcePasswordChange/`: cambio obligatorio de contraseña
- `SendEmailNotification/`: enviar emails de notificación
- `ResetUserPassword/`: reinicio de clave por admin
- `GetCompanySettings/`: obtener configuración SMTP
- `UpdateCompanySettings/`: actualizar configuración SMTP
- `GetUsers/`: listar usuarios (para admins)
- `CreateUser/`: crear usuario desde dashboard
- `UpdateCompanyData/`: editar datos de empresa

#### Modificaciones:
- `LoginCommandHandler.cs`: verificar validación de email y cambio obligatorio
- `RegisterCompanyCommandHandler.cs`: enviar email de notificación
- `CompanyContactService.cs`: integrar envío de emails

#### Nuevos Servicios:
- `EmailService.cs`: servicio de envío de emails
- `EmailValidationService.cs`: gestión de tokens de validación
- `UserManagementService.cs`: gestión de usuarios para admins

### 4. BACKEND - DATA ACCESS (Dualcomp.Auth.DataAccess.EntityFramework)

#### Nuevas Configuraciones:
- `EmailValidationConfiguration.cs`
- `CompanySettingsConfiguration.cs`

#### Nuevos Repositorios:
- `EmailValidationRepository.cs`
- `CompanySettingsRepository.cs`

#### Modificaciones:
- `UserConfiguration.cs`: agregar nuevos campos
- `CompanyConfiguration.cs`: agregar relación con settings

### 5. BACKEND - INFRASTRUCTURE (DualComp.Infraestructure)

#### Nuevos Servicios:
- `SmtpEmailService.cs`: implementación de envío de emails
- `EmailTemplateService.cs`: plantillas de emails

#### Modificaciones:
- `appsettings.json`: configuración SMTP por defecto

### 6. BACKEND - WEB API (Dualcomp.Auth.WebApi)

#### Nuevos Controllers:
- `EmailValidationController.cs`: endpoints de validación
- `UserManagementController.cs`: gestión de usuarios
- `CompanySettingsController.cs`: configuración de empresa

#### Modificaciones:
- `AuthController.cs`: agregar endpoint de cambio obligatorio
- `CompaniesController.cs`: integrar envío de emails

### 7. FRONTEND - ANGULAR

#### Nuevas Páginas:
- `src/app/auth/pages/validate-email/`: página de validación
- `src/app/auth/pages/force-password-change/`: cambio obligatorio
- `src/app/admin/users/`: gestión de usuarios
- `src/app/admin/company-settings/`: configuración de empresa

#### Nuevos Servicios:
- `EmailValidationService.ts`
- `UserManagementService.ts`
- `CompanySettingsService.ts`
- `EmailService.ts`

#### Nuevos Componentes:
- `user-list/`: lista de usuarios
- `user-form/`: formulario de usuario
- `company-settings-form/`: configuración SMTP
- `force-password-change/`: cambio obligatorio

#### Modificaciones:
- `login.component.ts`: redirección a cambio obligatorio
- `app.routes.ts`: nuevas rutas
- `sidebar.component.html`: nuevos menús para admins
- `main-page.component.html`: dashboard con accesos

## Algoritmos Implementados

### 1. Flujo de Validación por Email
1. Usuario se registra → `IsActive = false`, `IsEmailValidated = false`
2. Generar token único con expiración (24 horas)
3. Guardar en `EmailValidations` con `UserId`
4. Enviar email con enlace: `/validate-email?token={token}`
5. Usuario hace clic → validar token → `IsEmailValidated = true`, `IsActive = true`
6. Eliminar token usado

### 2. Flujo de Cambio Obligatorio de Contraseña
1. Usuario hace login → verificar `MustChangePassword = true`
2. Si es true → redirigir a `/force-password-change`
3. Solicitar clave temporal enviada por email
4. Validar clave temporal
5. Solicitar nueva contraseña que cumpla políticas
6. Actualizar contraseña → `MustChangePassword = false`
7. Invalidar sesiones y forzar re-login

### 3. Flujo de Envío de Emails
1. Obtener configuración SMTP de la empresa
2. Si no existe → usar configuración por defecto
3. Generar plantilla según tipo de notificación
4. Enviar email con configuración correspondiente
5. Registrar intento de envío (éxito/error)

### 4. Flujo de Reinicio de Clave por Admin
1. Verificar que usuario sea `IsCompanyAdmin = true`
2. Buscar usuario objetivo
3. Generar clave temporal
4. Actualizar contraseña del usuario
5. Enviar email con clave temporal
6. Registrar acción en log

## Fases de Implementación

### FASE 1: Base de Datos y Validación de Email
- Crear script SQL con nuevas tablas y campos
- Implementar entidades y repositorios
- Crear servicio de validación de email
- Implementar endpoints de validación

### FASE 2: Cambio Obligatorio de Contraseña
- Modificar flujo de login
- Implementar página de cambio obligatorio
- Integrar validación de clave temporal
- Actualizar flujo de autenticación

### FASE 3: Sistema de Emails
- Implementar servicio SMTP
- Crear plantillas de email
- Integrar envío en registro de empresas
- Configurar SMTP por empresa

### FASE 4: Gestión de Usuarios
- Implementar endpoints de gestión
- Crear páginas de administración
- Implementar permisos por roles
- Integrar con dashboard

### FASE 5: Configuración de Empresa
- Implementar configuración SMTP
- Crear páginas de settings
- Integrar con flujos existentes
- Validar configuración

## Consideraciones Técnicas

### Seguridad
- Tokens de validación con expiración corta
- Validación de permisos en todos los endpoints
- Logs de auditoría para acciones administrativas
- Encriptación de configuraciones SMTP

### Performance
- Índices en campos de búsqueda frecuente
- Cache de configuraciones SMTP
- Limpieza automática de tokens expirados
- Paginación en listados de usuarios

### Testing
- Tests unitarios para todos los nuevos servicios
- Tests de integración para flujos de email
- Tests de seguridad para validaciones
- Tests de UI para nuevas páginas

### Refactoring
- Extraer lógica común de envío de emails
- Unificar validaciones de contraseña
- Centralizar manejo de errores de email
- Optimizar consultas de usuarios

## Archivos de Configuración
- `appsettings.json`: configuración SMTP por defecto
- `email-templates/`: plantillas de email
- `migration-scripts/`: scripts de migración de datos
