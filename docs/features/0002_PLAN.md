### Plan técnico: Registro de una cliente (empresa con empleados)

Breve contexto
- **Objetivo**: Implementar el registro de una cliente (empresa) que puede contener una lista de empleados asociados.
- **Resultado**: Endpoint HTTP para crear empresa, persistencia en EF Core (InMemory por ahora), validaciones clave (únicidad de identificador fiscal), y pruebas.

Arquitectura y alcance
- **Capa Domain**: Agregado `Company` (empresa) como raíz; entidad `Employee` (empleado); value objects para datos críticos (p. ej. `TaxId`, `Email`).
- **Capa Application**: Comando `RegisterCompanyCommand` + handler; DTOs de request/response y mapeos.
- **Capa Infraestructure**: Mapeos EF Core, `DbSet` en `BaseDbContext`, repositorio específico opcional y uso de `IUnitOfWork` existente.
- **Capa WebApi**: Controlador `CompaniesController` con `POST /api/companies`.
- **Datos**: EF InMemory existente (`BaseDbContext`) se mantiene para la primera versión.

Cambios/archivos por capa
1) Domain (crear)
   - `src/Domain/Companies/Company.cs`: Agregado raíz con propiedades: Id, Name, TaxId, Address (simple o VO), Employees (colección). Reglas: TaxId único, Name obligatorio.
   - `src/Domain/Companies/Employee.cs`: Entidad con Id, FullName, Email (VO), Phone (opcional), pertenencia a Company.
   - `src/Domain/Companies/ValueObjects/TaxId.cs` y `Email.cs`: Validaciones de formato y estandarización.
   - `src/Domain/Companies/Events/CompanyRegistered.cs` (opcional) para futura integración de eventos.
   - `src/Domain/Companies/ICompanyRepository.cs` (opcional): Extiende `Domain.Abstractions.Repositories.IRepository<Company>` y agrega `Task<bool> ExistsByTaxIdAsync(...)`.

2) Application (crear)
   - `src/Application/Companies/RegisterCompany/RegisterCompanyCommand.cs`: Datos de entrada: Name, TaxId, Address (simple), Employees: lista de { FullName, Email, Phone }.
   - `src/Application/Companies/RegisterCompany/RegisterCompanyCommandHandler.cs`: Flujo: validar, verificar unicidad TaxId, construir agregado `Company`, invocar repositorio y `IUnitOfWork.SaveChangesAsync`, retornar Id generado.
   - `src/Application/Companies/RegisterCompany/RegisterCompanyResult.cs`: Id de la empresa creada y eco de datos clave.
   - Mapeo: usar `Application.Abstractions.Mapping.IMapper` si aplica; en su defecto, mapear en handler.

3) Infraestructure (editar/crear)
   - Editar `src/Infraestructure/Persistence/Ef/BaseDbContext.cs`: Agregar `DbSet<Company>` y `DbSet<Employee>`.
   - Crear `src/Infraestructure/Persistence/Ef/Configurations/CompanyConfiguration.cs` y `EmployeeConfiguration.cs`: Keys, propiedades requeridas, índice único en TaxId, relación 1-N (Company -> Employees) con delete behavior apropiado.
   - Repositorio: crear `src/Infraestructure/Persistence/Ef/CompanyRepository.cs` si se define `ICompanyRepository`, implementando `ExistsByTaxIdAsync` y heredando de `EfRepository<Company>`.
   - DI: `src/Infraestructure/Configuration/ServiceCollectionExtensions.cs`: registrar `IRepository<Company>` (ya genérico) y opcional `ICompanyRepository` concreto; no cambiar `IUnitOfWork`.

4) WebApi (crear)
   - `src/WebApi/Controllers/CompaniesController.cs`: `POST /api/companies` que recibe el payload del comando, delega a Application y retorna 201 con ubicación del recurso y cuerpo `RegisterCompanyResult`.
   - Contratos: reutilizar el comando como contrato o crear `CreateCompanyRequest`/`CompanyEmployeeDto` en WebApi y mapear a `RegisterCompanyCommand`.
   - Middleware de errores ya presente (`ExceptionHandlingMiddleware`) gestionará respuestas de error estándar.

Flujo/algoritmo del registro (paso a paso)
1. WebApi recibe `POST /api/companies` con: Name (string), TaxId (string), Address (string opcional/simple), Employees: lista { FullName, Email, Phone }.
2. WebApi valida formato básico (p. ej. body no nulo) y mapea a `RegisterCompanyCommand`.
3. Handler:
   - 3.1. Validar que `Name` y `TaxId` no estén vacíos; validar `Email` de empleados si vienen.
   - 3.2. Consultar repositorio: `ExistsByTaxIdAsync(TaxId)` para asegurar unicidad.
   - 3.3. Construir `Company` con value objects `TaxId` y `Email` por empleado; agregar empleados a la colección del agregado.
   - 3.4. `repository.AddAsync(company)` seguido de `unitOfWork.SaveChangesAsync()`.
   - 3.5. Retornar `RegisterCompanyResult` con `CompanyId` y datos clave.
4. WebApi responde 201 Created con header Location `/api/companies/{id}` y cuerpo con el resultado.

Validaciones y reglas
- **TaxId único**: Índice único en EF y chequeo previo en handler para error amigable.
- **Name requerido**: Validación en Dominio y/o handler.
- **Email válido**: Validación en VO `Email`.
- **Idempotencia (opcional)**: Si llega el mismo TaxId, retornar error de conflicto (409) con mensaje claro.

Consideraciones de persistencia (EF InMemory)
- `BaseDbContext` ya usa InMemory (`ServiceCollectionExtensions`). No se requieren migraciones en esta fase.
- Aun así, configurar entidades e índices en configuraciones para futura migración a provider relacional.

Endpoints y contratos
- `POST /api/companies`
  - Request: `{ name, taxId, address?, employees?: [{ fullName, email, phone? }] }`
  - Responses: 201 (Created con `RegisterCompanyResult`), 400 (validación), 409 (TaxId duplicado), 500 (inesperado).

Pruebas
- Unit: Handler de `RegisterCompanyCommand` cubriendo: alta feliz, TaxId duplicado, email inválido, sin empleados.
- Integration: `POST /api/companies` sobre InMemory validando 201 y persistencia de empleados.

Fases (pequeñas, paralelizables tras la base)
- Fase 1 (Datos): Entidades Domain, VO, configuraciones EF, `DbSet` y repositorio.
- Fase 2A (Aplicación): Comando, handler, resultados.
- Fase 2B (API): Controller y contratos.
- Fase 3 (Pruebas): Unit + Integration.

Notas de implementación
- Mantener nombres en inglés en código si el resto del repo sigue ese patrón (`Company`, `Employee`).
- Evitar dependencias nuevas; usar validaciones en VO/handler. Si se introduce `FluentValidation`, registrarlo en Infra/WebApi.
- Mantener `IRepository<>` e `IUnitOfWork` existentes; sólo crear `ICompanyRepository` si la verificación de unicidad requiere firma dedicada.


