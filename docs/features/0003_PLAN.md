# Plan Técnico: Sistema de Autenticación y Gestión de Empresas

## Descripción

Implementar un sistema completo de autenticación y gestión de empresas que incluya:
- Modelo de datos para usuarios con autenticación segura
- Sistema de login/logout con JWT (access + refresh tokens)
- Gestión de sesiones activas con invalidación automática
- CRUD completo para empresas y empleados
- Validación de contraseñas con criterios de seguridad parametrizables
- Proyecto de base de datos con scripts SQL
- Tests unitarios con máxima cobertura

## Archivos y Funciones a Modificar/Crear

### Fase 1: Modelo de Datos y Base de Datos

#### Nuevos archivos a crear:
- `src/backend/Dualcomp.Auth.Domain/Users/User.cs` - Entidad de usuario con autenticación
- `src/backend/Dualcomp.Auth.Domain/Users/UserSession.cs` - Entidad para sesiones activas
- `src/backend/Dualcomp.Auth.Domain/Users/ValueObjects/Password.cs` - Value object para contraseñas
- `src/backend/Dualcomp.Auth.Domain/Users/ValueObjects/HashedPassword.cs` - Value object para contraseñas hasheadas
- `src/backend/Dualcomp.Auth.Domain/Users/IUserRepository.cs` - Repositorio de usuarios
- `src/backend/Dualcomp.Auth.Domain/Users/IUserSessionRepository.cs` - Repositorio de sesiones
- `src/backend/Dualcomp.Auth.DataAccess.EntityFramework/Configurations/UserConfiguration.cs` - Configuración EF para User
- `src/backend/Dualcomp.Auth.DataAccess.EntityFramework/Configurations/UserSessionConfiguration.cs` - Configuración EF para UserSession
- `src/backend/Dualcomp.Auth.DataAccess.EntityFramework/Repositories/UserRepository.cs` - Implementación del repositorio de usuarios
- `src/backend/Dualcomp.Auth.DataAccess.EntityFramework/Repositories/UserSessionRepository.cs` - Implementación del repositorio de sesiones
- `src/backend/Dualcomp.Auth.Database/` - Nuevo proyecto para scripts de base de datos
- `src/backend/Dualcomp.Auth.Database/Scripts/001_CreateTables.sql` - Script de creación de tablas
- `src/backend/Dualcomp.Auth.Database/Scripts/002_InitialData.sql` - Script de datos iniciales

#### Archivos a modificar:
- `src/backend/Dualcomp.Auth.Domain/Companies/Employee.cs` - Agregar relación con User y campos de autenticación
- `src/backend/Dualcomp.Auth.DataAccess.EntityFramework/Configurations/EmployeeConfiguration.cs` - Actualizar configuración para nuevos campos
- `src/backend/Dualcomp.Auth.DataAccess.EntityFramework/BaseDbContext.cs` - Agregar DbSets para User y UserSession
- `src/backend/Dualcomp.Auth.DataAccess.EntityFramework/Configurations/ServiceCollectionExtensions.cs` - Registrar nuevos repositorios

### Fase 2A: Infraestructura de Autenticación

#### Nuevos archivos a crear:
- `src/backend/DualComp.Infraestructure/Security/IPasswordHasher.cs` - Interfaz para hashing de contraseñas
- `src/backend/DualComp.Infraestructure/Security/BCryptPasswordHasher.cs` - Implementación con BCrypt
- `src/backend/DualComp.Infraestructure/Security/IPasswordValidator.cs` - Interfaz para validación de contraseñas
- `src/backend/DualComp.Infraestructure/Security/PasswordValidator.cs` - Implementación de validación
- `src/backend/DualComp.Infraestructure/Security/IJwtTokenService.cs` - Interfaz para generación de tokens JWT
- `src/backend/DualComp.Infraestructure/Security/JwtTokenService.cs` - Implementación de JWT
- `src/backend/DualComp.Infraestructure/Security/JwtSettings.cs` - Configuración de JWT
- `src/backend/DualComp.Infraestructure/Web/Authentication/JwtAuthenticationMiddleware.cs` - Middleware de autenticación JWT
- `src/backend/DualComp.Infraestructure/Web/Authentication/JwtAuthenticationExtensions.cs` - Extensiones para configuración JWT

#### Archivos a modificar:
- `src/backend/Dualcomp.Auth.WebApi/appsettings.json` - Agregar configuración de JWT, validación de contraseñas y sesiones
- `src/backend/Dualcomp.Auth.WebApi/appsettings.Development.json` - Configuración de desarrollo
- `src/backend/Dualcomp.Auth.WebApi/Program.cs` - Configurar servicios de autenticación y middleware

### Fase 2B: Application Layer - Autenticación

#### Nuevos archivos a crear:
- `src/backend/Dualcomp.Auth.Application/Users/Login/LoginCommand.cs` - Comando para login
- `src/backend/Dualcomp.Auth.Application/Users/Login/LoginCommandHandler.cs` - Handler para login
- `src/backend/Dualcomp.Auth.Application/Users/Login/LoginResult.cs` - Resultado del login
- `src/backend/Dualcomp.Auth.Application/Users/Logout/LogoutCommand.cs` - Comando para logout
- `src/backend/Dualcomp.Auth.Application/Users/Logout/LogoutCommandHandler.cs` - Handler para logout
- `src/backend/Dualcomp.Auth.Application/Users/ChangePassword/ChangePasswordCommand.cs` - Comando para cambio de contraseña
- `src/backend/Dualcomp.Auth.Application/Users/ChangePassword/ChangePasswordCommandHandler.cs` - Handler para cambio de contraseña
- `src/backend/Dualcomp.Auth.Application/Users/RefreshToken/RefreshTokenCommand.cs` - Comando para refresh token
- `src/backend/Dualcomp.Auth.Application/Users/RefreshToken/RefreshTokenCommandHandler.cs` - Handler para refresh token

### Fase 2C: Application Layer - Gestión de Empresas y Empleados

#### Nuevos archivos a crear:
- `src/backend/Dualcomp.Auth.Application/Companies/UpdateCompany/UpdateCompanyCommand.cs` - Comando para actualizar empresa
- `src/backend/Dualcomp.Auth.Application/Companies/UpdateCompany/UpdateCompanyCommandHandler.cs` - Handler para actualizar empresa
- `src/backend/Dualcomp.Auth.Application/Companies/GetCompany/GetCompanyQuery.cs` - Query para obtener empresa
- `src/backend/Dualcomp.Auth.Application/Companies/GetCompany/GetCompanyQueryHandler.cs` - Handler para obtener empresa
- `src/backend/Dualcomp.Auth.Application/Companies/GetCompanies/GetCompaniesQuery.cs` - Query para listar empresas
- `src/backend/Dualcomp.Auth.Application/Companies/GetCompanies/GetCompaniesQueryHandler.cs` - Handler para listar empresas
- `src/backend/Dualcomp.Auth.Application/Employees/CreateEmployee/CreateEmployeeCommand.cs` - Comando para crear empleado
- `src/backend/Dualcomp.Auth.Application/Employees/CreateEmployee/CreateEmployeeCommandHandler.cs` - Handler para crear empleado
- `src/backend/Dualcomp.Auth.Application/Employees/UpdateEmployee/UpdateEmployeeCommand.cs` - Comando para actualizar empleado
- `src/backend/Dualcomp.Auth.Application/Employees/UpdateEmployee/UpdateEmployeeCommandHandler.cs` - Handler para actualizar empleado
- `src/backend/Dualcomp.Auth.Application/Employees/GetEmployee/GetEmployeeQuery.cs` - Query para obtener empleado
- `src/backend/Dualcomp.Auth.Application/Employees/GetEmployee/GetEmployeeQueryHandler.cs` - Handler para obtener empleado
- `src/backend/Dualcomp.Auth.Application/Employees/GetEmployees/GetEmployeesQuery.cs` - Query para listar empleados
- `src/backend/Dualcomp.Auth.Application/Employees/GetEmployees/GetEmployeesQueryHandler.cs` - Handler para listar empleados

#### Archivos a modificar:
- `src/backend/Dualcomp.Auth.Application/Companies/RegisterCompany/RegisterCompanyCommand.cs` - Refactorizar para incluir usuario admin
- `src/backend/Dualcomp.Auth.Application/Companies/RegisterCompany/RegisterCompanyCommandHandler.cs` - Refactorizar para crear usuario admin

### Fase 2D: Web API Controllers

#### Nuevos archivos a crear:
- `src/backend/Dualcomp.Auth.WebApi/Controllers/AuthController.cs` - Controller para autenticación
- `src/backend/Dualcomp.Auth.WebApi/Controllers/EmployeesController.cs` - Controller para empleados

#### Archivos a modificar:
- `src/backend/Dualcomp.Auth.WebApi/Controllers/CompaniesController.cs` - Agregar endpoints faltantes (GET, PUT, DELETE)

### Fase 3: Tests Unitarios

#### Nuevos archivos a crear:
- `src/tests/UnitTests/Users/LoginCommandHandlerTests.cs` - Tests para login
- `src/tests/UnitTests/Users/LogoutCommandHandlerTests.cs` - Tests para logout
- `src/tests/UnitTests/Users/ChangePasswordCommandHandlerTests.cs` - Tests para cambio de contraseña
- `src/tests/UnitTests/Users/RefreshTokenCommandHandlerTests.cs` - Tests para refresh token
- `src/tests/UnitTests/Companies/UpdateCompanyCommandHandlerTests.cs` - Tests para actualizar empresa
- `src/tests/UnitTests/Companies/GetCompanyQueryHandlerTests.cs` - Tests para obtener empresa
- `src/tests/UnitTests/Companies/GetCompaniesQueryHandlerTests.cs` - Tests para listar empresas
- `src/tests/UnitTests/Employees/CreateEmployeeCommandHandlerTests.cs` - Tests para crear empleado
- `src/tests/UnitTests/Employees/UpdateEmployeeCommandHandlerTests.cs` - Tests para actualizar empleado
- `src/tests/UnitTests/Employees/GetEmployeeQueryHandlerTests.cs` - Tests para obtener empleado
- `src/tests/UnitTests/Employees/GetEmployeesQueryHandlerTests.cs` - Tests para listar empleados
- `src/tests/UnitTests/Security/PasswordValidatorTests.cs` - Tests para validación de contraseñas
- `src/tests/UnitTests/Security/JwtTokenServiceTests.cs` - Tests para servicio JWT
- `src/tests/UnitTests/Infrastructure/BCryptPasswordHasherTests.cs` - Tests para hashing de contraseñas

#### Archivos a modificar:
- `src/tests/UnitTests/Companies/RegisterCompanyCommandHandlerTests.cs` - Actualizar tests existentes

## Algoritmos y Lógica de Negocio

### 1. Sistema de Autenticación
- **Login**: Validar credenciales → Verificar sesiones activas → Invalidar sesiones previas → Crear nueva sesión → Generar tokens JWT
- **Logout**: Invalidar token actual → Eliminar sesión de base de datos
- **Refresh Token**: Validar refresh token → Generar nuevos access/refresh tokens → Actualizar sesión

### 2. Gestión de Sesiones
- **Una sesión activa por usuario**: Al hacer login, invalidar todas las sesiones previas del usuario
- **Expiración automática**: Verificar expiración en cada request autenticado
- **Limpieza de sesiones**: Job en background para limpiar sesiones expiradas

### 3. Validación de Contraseñas
- **Criterios parametrizables**: Longitud mínima, caracteres requeridos (mayúscula, minúscula, número, símbolo)
- **Expresión regular configurable**: Para validación de formato
- **Hashing seguro**: BCrypt con salt automático

### 4. JWT Configuration
- **Access Token**: Tiempo de vida corto (configurable, ej: 15 minutos)
- **Refresh Token**: Tiempo de vida largo (configurable, ej: 7 días)
- **Claims**: userId, companyId, email, sessionId

## Configuración de appsettings.json

```json
{
  "JwtSettings": {
    "SecretKey": "your-secret-key-here",
    "Issuer": "DualComp.Auth",
    "Audience": "DualComp.Auth.Users",
    "AccessTokenExpirationMinutes": 15,
    "RefreshTokenExpirationDays": 7
  },
  "PasswordValidation": {
    "MinLength": 8,
    "RequireUppercase": true,
    "RequireLowercase": true,
    "RequireDigit": true,
    "RequireSpecialCharacter": true,
    "ValidationRegex": "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]"
  },
  "SessionSettings": {
    "DefaultExpirationMinutes": 60,
    "CleanupIntervalMinutes": 30
  }
}
```

## Consideraciones de Seguridad

1. **Contraseñas**: Hash con BCrypt, nunca almacenar en texto plano
2. **Tokens JWT**: Firmados con clave secreta fuerte, expiración corta para access tokens
3. **Sesiones**: Almacenadas en base de datos con expiración automática
4. **Validación**: Input validation en todos los endpoints
5. **HTTPS**: Requerido en producción
6. **Rate Limiting**: Implementar para endpoints de autenticación

## Dependencias Nuevas

- `Microsoft.AspNetCore.Authentication.JwtBearer` - Para JWT authentication
- `BCrypt.Net-Next` - Para hashing de contraseñas
- `System.IdentityModel.Tokens.Jwt` - Para generación de tokens JWT
- `Microsoft.EntityFrameworkCore.SqlServer` - Para SQL Server (si no está ya)
