# Plan Técnico: Ajuste Frontend Angular a API .NET

## Descripción
Ajustar el frontend Angular existente para que funcione correctamente con la API .NET del backend, corrigiendo los DTOs, requests, flujo de autenticación y gestión de tokens JWT. El frontend actual tiene problemas de compatibilidad con la API real y necesita ser adaptado según los lineamientos del FE_Brief.md.

## Problemas Identificados

### 1. Incompatibilidad de DTOs y Requests
- **Frontend actual**: Usa `LoginRequest` con `organizationId`, `userName`, `password`, `closeOpenedSessions`
- **Backend real**: Espera `LoginRequest` con `Email`, `Password` únicamente
- **URL incorrecta**: Frontend apunta a `/api/login/login` pero backend expone `/api/auth/login`

### 2. Flujo de Autenticación Incorrecto
- **Problema**: La aplicación inicia en dashboard si hay token válido
- **Requerimiento**: Siempre debe iniciar en login según FE_Brief.md
- **AuthGuard**: No valida expiración del token, solo existencia

### 3. Gestión de Tokens Insegura e Ineficiente
- **Almacenamiento**: Usa localStorage (inseguro para tokens sensibles)
- **Refresh Token**: URL incorrecta `/api/login/refresh-token` vs `/api/auth/refresh-token`
- **Estructura de respuesta**: Frontend espera `{token, refreshToken}` pero backend devuelve `{accessToken, refreshToken, expiresAt, user}`

### 4. Configuración de Entornos
- **Environment files**: Vacíos, no configurados
- **API Base URL**: Hardcodeada en servicios

## Archivos a Modificar

### Frontend - Servicios de Autenticación
- `src/app/auth/services/LoginService.ts` - Corregir request/response DTOs y URL
- `src/app/auth/services/AuthService .ts` - Mejorar gestión de tokens y almacenamiento
- `src/app/auth/services/AuthInterceptor.ts` - Corregir URL de refresh token
- `src/app/auth/services/AuthGuard.ts` - Validar expiración de tokens

### Frontend - Componentes
- `src/app/auth/pages/login/login.component.ts` - Ajustar request de login
- `src/app/app.routes.ts` - Modificar redirección inicial

### Frontend - Configuración
- `src/app/environments/environment.ts` - Configurar API base URL
- `src/app/environments/environment.development.ts` - Configurar entorno desarrollo

## Algoritmo de Corrección

### Fase 1: Configuración de Entornos
1. Configurar `environment.ts` con API base URL
2. Configurar `environment.development.ts` con URL de desarrollo
3. Actualizar servicios para usar configuración de entorno

### Fase 2: Corrección de DTOs y Requests
1. Crear interfaces TypeScript que coincidan con la API .NET:
   - `LoginRequest`: `{ email: string, password: string }`
   - `LoginResponse`: `{ accessToken: string, refreshToken: string, expiresAt: string, user: UserInfo }`
   - `UserInfo`: `{ id: string, email: string, fullName: string, companyId: string, isCompanyAdmin: boolean }`
2. Actualizar `LoginService` para usar las nuevas interfaces
3. Corregir URL de login de `/api/login/login` a `/api/auth/login`

### Fase 3: Mejora de Gestión de Tokens
1. Implementar almacenamiento más seguro (sessionStorage para tokens, localStorage para preferencias)
2. Agregar validación de expiración de tokens
3. Actualizar `AuthService` para manejar la nueva estructura de respuesta
4. Corregir URL de refresh token en `AuthInterceptor`

### Fase 4: Corrección del Flujo de Autenticación
1. Modificar `app.routes.ts` para que siempre redirija a login inicialmente
2. Actualizar `AuthGuard` para validar expiración de tokens
3. Implementar lógica de redirección post-login basada en estado de autenticación

### Fase 5: Validación y Testing
1. Probar flujo completo de login/logout
2. Verificar refresh token automático
3. Validar redirecciones y guards
4. Confirmar compatibilidad con API .NET

## Consideraciones Técnicas

### Seguridad
- Usar sessionStorage para tokens (se elimina al cerrar navegador)
- Implementar validación de expiración antes de hacer requests
- Sanitizar inputs en formularios de login

### Performance
- Evitar requests innecesarios validando tokens localmente
- Implementar cache de información de usuario
- Optimizar interceptors para evitar loops infinitos

### Mantenibilidad
- Centralizar configuración de URLs en environment files
- Crear interfaces TypeScript reutilizables
- Documentar cambios en DTOs y flujos

## Criterios de Éxito
- Login funciona correctamente con la API .NET real
- Aplicación siempre inicia en pantalla de login
- Tokens se gestionan de forma segura y eficiente
- Refresh token funciona automáticamente
- Guards protegen rutas correctamente
- No hay errores de compatibilidad con la API

